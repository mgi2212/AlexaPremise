<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
      <meta name="description" content="">
      <meta name="author" content="">
      <link rel="icon" href="favicon.ico">
      <title>Premise Bridge</title>
      <!-- Bootstrap core CSS -->
      <link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
      <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
      <link href="css/ie10-viewport-bug-workaround.css" rel="stylesheet">
      <link href="css/page.css" rel="stylesheet">
      <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
      <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
   </head>
   <body>
      <div id="alertContainer"></div>
      <div id="amazon-root"></div>
      <script type="text/javascript">
         window.onAmazonLoginReady = function() {
           amazon.Login.setClientId('amzn1.application-oa2-client.b659c342aba9405eb5afc9509716d51f');
         };
         (function(d) {
           var a = d.createElement('script'); a.type = 'text/javascript';
           a.async = true; a.id = 'amazon-login-sdk';
           a.src = 'https://api-cdn.amazon.com/sdk/login1.js';
           d.getElementById('amazon-root').appendChild(a);
         })(document);
      </script>
      <nav class="navbar navbar-inverse navbar-fixed-top navbar-light bg-faded">
         <div class="container">
            <div class="navbar-header">
               <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
               </button>
               <a class="navbar-brand mb-0" href="#">Premise Bridge - Registration</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse navbar-right">
               <ul class="nav navbar-nav" id="NavItems" hidden>
                  <li id="LogoutLi" class="nav-item" style="padding-top:0.6em" ><button id="Logout" class="btn" >Logout</button></li>
               </ul>
            </div>

         </div>
      </nav>
      <div class="container">
         <div class="home-page-content">
            <h2>Premise Bridge User Registration</h2>
            <p class="lead"><br></p>
            <div id="login">
               <a href id="LoginWithAmazon">
                  <div class="row">
                     <div class="col-xs-12 hidden-sm hidden-md hidden-lg">
                        <img border="0" alt="Login with Amazon"
                           src="https://images-na.ssl-images-amazon.com/images/G/01/lwa/btnLWA_gold_156x32.png"
                           width="156" height="32" />    <!--Mobile-->
                     </div>
                     <div class="hidden-xs col-sm-12 hidden-md hidden-lg">
                        <img border="0" alt="Login with Amazon"
                           src="https://images-na.ssl-images-amazon.com/images/G/01/lwa/btnLWA_gold_156x32.png"
                           width="156" height="32" />    <!--Tab-->
                     </div>
                     <div class="hidden-xs hidden-sm col-md-12 hidden-lg">
                        <img border="0" alt="Login with Amazon"
                           src="https://images-na.ssl-images-amazon.com/images/G/01/lwa/btnLWA_gold_312x64.png"
                           width="312" height="64" />    <!--Desktop-->
                     </div>
                     <div class="hidden-xs hidden-sm hidden-md col-lg-12">
                        <img border="0" alt="Login with Amazon"
                           src="https://images-na.ssl-images-amazon.com/images/G/01/lwa/btnLWA_gold_390x92.png"
                           width="390" height="92" />    <!--Large-->
                     </div>
                  </div>
               </a>
               <br>
               <span><small><i>Please note: you will need to enable pop-ups to click this button.</i></small></span>
            </div>
            <div class="row clearfix" id="pagedata" hidden>
               <div class="col-md-6 col-md-offset-3 column">
                  <div class="form-group">
                     <label for="nameInput">Name</label>
                     <input type="text" class="form-control" id="nameInput" size="10" readonly>
                  </div>
                  <div class="form-group">
                     <label for="emailInput">Email</label>
                     <input type="email" class="form-control" id="emailInput" size="10" readonly>
                  </div>
                  <div id="formData">
                     <div class="form-group">
                        <label for="hostInput">Host
                            <small>
                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" title="Your host name. Example: alexa.example.us">
                                </span>
                            </small>
                        </label>
                        <input type="text" class="form-control form-control-editable" id="hostInput" size="10" autofocus readonly>
                     </div>
                     <div class="form-group">
                        <label for="pathInput">Path 
                            <small>
                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" title="Your app path. Example: /Alexa.svc/jsons/">
                                </span>
                            </small>
                        </label>
                        <input type="text" class="form-control form-control-editable" id="pathInput" size="10" readonly>
                     </div>
                     <div class="form-group">
                        <label for="portInput">Port 
                            <small>
                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" title="Your host's port. Example: 8733">
                                </span>
                            </small>
                        </label>
                        <input type="text" class="form-control form-control-editable" id="portInput" size="10" readonly>
                     </div>
                     <div class="form-group">
                        <label for="tokenInput">Premise Access Token 
                            <small>
                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" title="You access token. Example: z5699rt0d">
                                </span>
                            </small>
                        </label>
                        <input type="text" class="form-control form-control-editable" id="tokenInput" size="10" readonly>
                     </div>
                     <button id="submitButton" type="submit" onclick="submitClick()" class="btn btn-primary">Register</button>
                     <button id="editButton" type="edit" onclick="editClick()" class="btn btn-primary" hidden>Edit</button>
                     <button id="resetButton" type="reset" onclick="resetClick()" class="btn btn-default">Reset</button>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <!-- Bootstrap core JavaScript
         ================================================== -->
      <!-- Placed at the end of the document so the pages load faster -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
      <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-notify/0.2.0/js/bootstrap-notify.min.js"></script>
      <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
      <script src="js/ie10-viewport-bug-workaround.js"></script>
      <!-- API Gateway Javascript SDK Dependencies -->
      <script type="text/javascript" src="lib/axios/dist/axios.standalone.js"></script>
      <script type="text/javascript" src="lib/CryptoJS/rollups/hmac-sha256.js"></script>
      <script type="text/javascript" src="lib/CryptoJS/rollups/sha256.js"></script>
      <script type="text/javascript" src="lib/CryptoJS/components/hmac.js"></script>
      <script type="text/javascript" src="lib/CryptoJS/components/enc-base64.js"></script>
      <script type="text/javascript" src="lib/url-template/url-template.js"></script>
      <script type="text/javascript" src="lib/apiGatewayCore/sigV4Client.js"></script>
      <script type="text/javascript" src="lib/apiGatewayCore/apiGatewayClient.js"></script>
      <script type="text/javascript" src="lib/apiGatewayCore/simpleHttpClient.js"></script>
      <script type="text/javascript" src="lib/apiGatewayCore/utils.js"></script>
      <script type="text/javascript" src="apigClient.js"></script> 
      <script type="text/javascript">
      
        var customerId; // global variable to hold CustomerId.
        
        /**
         *  Enable Bootstrap's tool tips, set customerId holder to empty, and setup Bootstrap alert.
         */
        $(document).ready(function(){
            $('[data-toggle="tooltip"]').tooltip();
            customerId = '';
            $(".alert").alert()
        });
        
        /**
         *  Iniitalize API Gateway Client
         */
        var apigClient = apigClientFactory.newClient({
         apiKey: '4agggHAInL9ZdkosPF2v08ZOPFeNA9Rk6Euq9p1B'
        });

        /**
         *  Add click event handeler for Login With Amazon component.
         */
        $('#LoginWithAmazon').click(function() {
          setTimeout(window.doLogin, 1000);
          return false;
        });
        
        /**
         *  Add click event handeler for log out functionality.
         */
        $('#Logout').click(function() {
          amazon.Login.logout();
          showLogon();
          return false;
        });

        /**
         * Performs the action of logging into Amazon LWA.
         */
        window.doLogin = function() {
         options = { scope: 'profile' };
         amazon.Login.authorize(options, function(response) {
            if ( response.error ) {
                attachAlert('<strong>oauth error!</strong> ' + response.error);
                return;
            }
            amazon.Login.retrieveProfile(response.access_token, function(response) {
               showForm(response);

               if ( window.console && window.console.log )
                  window.console.log(response);
            });
         });
        };

        /**
         * Performs the view manipulation for showing log in component.
         */
        var showLogon = function() {
           $('#pagedata').hide();
           $('#login').show();
           $('.form-control').val('');
           customerId = '';
           $('#NavItems').hide();
        }
        
        /**
         * Performs the view manipulation for entering the registration data component.
         */        
        var showForm = function(response) {
           $('#login').hide();
           $('#nameInput').val(response.profile.Name);
           $('#emailInput').val(response.profile.PrimaryEmail);
           customerId = response.profile.CustomerId;
           getAndUpdateData(response.profile.CustomerId);
           $('#NavItems').show();
           $('#pagedata').show();
           $('#editButton').hide();
        }

        /**
         * Performs the view manipulation for getting the registration data component.
         */
        var updateFormData = function(result) {
            $(".form-control-editable").prop("readonly", true);
            $('#submitButton').hide();
            $('#resetButton').hide();
            $('#editButton').show();
            $('#hostInput').val(result.data.Item.host.S);
            $('#pathInput').val(result.data.Item.app_path.S);
            $('#portInput').val(result.data.Item.port.S);
            $('#tokenInput').val(result.data.Item.access_token.S);
        }

        /**
         * Performs the view manipulation for editing the registration data component.
         */
        var prepareFormEntry = function() {
            $(".form-control-editable").prop("readonly", false);
            $('#submitButton').show();
            $('#resetButton').show();
        }

        /**
         * Click handler for submitting the registration data.
         */
        var submitClick = function() {
            submitData();
            $(".form-control-editable").prop("readonly", true);
            $('#submitButton').hide();
            $('#resetButton').hide();
            $('#editButton').show();
        }

        /**
         * Click handler for editing the registration data.
         */
        var editClick = function() {
            $(".form-control-editable").prop("readonly", false);
            $('#submitButton').show();
            $('#resetButton').show();
            $('#editButton').hide();
        }

        /**
         * Click handler for resetting the registration data (locally).
         */
        var resetClick = function() {
            $('.form-control-editable').val('');
        }

        /**
         * Performs the action and view manipulation for getting the registration data.
         */
        var getAndUpdateData = function(customerId) {
           var body = {
             "function": "getItem",
             "id": customerId
           };

           apigClient.premiseDBMicroservicePost({}, body)
              .then(function(result){
                 if (result.data.Item) {
                   updateFormData(result);
                 } else {
                   prepareFormEntry();
                 }}).catch(function(result){
                   attachAlert('<strong>something went wrong; sorry!</strong> Please try back in a little bit.');
                 });
        }

        /**
         * Performs the action and view manipulation for submitting the registration data.
         */
        var submitData = function() {

            var id = customerId;
            if (!id || id == '') {
                alert("Something went wrong! Please logout, then log back in.");
                return;
            }
            var body = {
                "function": "putItem",
                "id": id,
                "host": $('#hostInput').val(),
                "port": $('#portInput').val(),
                "app_path": $('#pathInput').val(),
                "access_token": $('#tokenInput').val()
            };

            apigClient.premiseDBMicroservicePost({}, body)
                .then(function(result){
                    return;	
                }).catch(function(result){
                    attachAlert('<strong>something went wrong; sorry!</strong> Please try back in a little bit.');
                });
        }
        
        /**
         * Attaches an alert (Bootstrap, alert-danger) with a message and a close button.
         */
        var attachAlert = function(messageHtml) {
            $('#alertContainer').html('<div id="alert" class="alert alert-danger alert-dismissible show" role="alert">' + 
                                      '   <button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                      '      <span aria-hidden="true">&times;</span>' + 
                                      '    </button>' +
                                      '    <span id="alertMessage"></span>' + 
                                      '</div>');
            $('#alertMessage').html(messageHtml);
        }            
             
      </script>
   </body>
</html>